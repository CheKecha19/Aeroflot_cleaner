# Aeroflot_cleaner
Программа для сравнения пользователей Active Directory с внешними системами

## Описание

Программа предназначена для автоматизации процесса сравнения пользователей Active Directory с данными из различных систем:
- 1С
- Сфера Курьер (ранее Диадок)
- Контур Диадок (ранее Контур)
- Штатное расписание

Программа анализирует данные, выявляет расхождения, дубликаты и пользователей, которых необходимо удалить из систем.

## Функциональность

- **Экспорт данных из Active Directory** - автоматическое получение информации о сотрудниках и ГПХ
- **Загрузка данных из внешних систем** - обработка Excel файлов из 1С, Сферы Курьер, Контур Диадок
- **Сравнение данных** - поиск расхождений между AD и другими системами
- **Выявление дубликатов** - поиск повторяющихся записей внутри каждой системы
- **Формирование отчетов** - создание структурированных Excel отчетов с результатами анализа
- **Подсветка проблемных записей** - цветовое выделение дубликатов и несоответствий

## Структура проекта

```
project/
├── config.py                   # Настройки путей и параметров
├── main.py                     # Главный скрипт запуска
├── excel_processor.py          # Основной процессор Excel данных
├── ad_export.py                # Экспорт данных из Active Directory
├── utils.py                    # Вспомогательные функции
├── comparison.py               # Функции сравнения данных
├── requirements.txt            # Зависимости Python
├── processors/                 # Модули обработки данных
│   ├── __init__.py
│   ├── onec_processor.py       # Обработчик 1С 
│   ├── diadoc_processor.py     # Обработчик Сфера Курьер
│   └── kontur_processor.py     # Обработчик Контур Диадок
├── эксельки/                   # Входные данные
│   ├── AD/                     # Файлы экспорта из AD (создаются автоматически)
│   ├── штатка/                 # Файлы штатного расписания
│   ├── 1С/                     # Выгрузки из системы 1С
│   ├── эдо_контур_диадок/      # Данные из Контур Диадок
│   └── эдо_сфера_курьер/       # Данные из Сфера Курьер
└── вывод/                      # Результаты обработки
    ├── результат_обработки_YYYYMMDD_HHMMSS.xlsx
    └── log/                    # Логи программы
```

## Установка и настройка

### Предварительные требования

- Python 3.7 или выше
- PowerShell (для экспорта из Active Directory)
- Доступ к Active Directory
- Права на чтение/запись файлов

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Подготовка данных

Поместите файлы в соответствующие директории:

- **AD/** - файлы экспорта из Active Directory (создаются автоматически)
- **штатка/** - файлы штатного расписания (любой Excel файл)
- **1С/** - выгрузки из системы 1С (любой Excel файл)
- **эдо_контур_диадок/** - данные из Контур Диадок (любой Excel файл)
- **эдо_сфера_курьер/** - данные из Сфера Курьер (любой Excel файл)

**Важно:** Программа автоматически находит самый новый файл в каждой папке. Не нужно переименовывать файлы!

## Использование

### Запуск программы

```bash
python main.py
```

### Выбор опций проверки

При запуске программа предложит выбрать:

1. **Системы для проверки:**
   - 0 - Все системы
   - 1 - 1С
   - 2 - Сфера Курьер
   - 3 - Контур Диадок

2. **Типы сотрудников:**
   - 0 - Все типы
   - 1 - Сотрудники
   - 2 - ГПХ

### Результаты работы

Программа создает в папке `вывод/` следующие файлы:

- `результат_обработки_YYYYMMDD_HHMMSS.xlsx` - основной файл с результатами
- `ad_users_export.xlsx` - полный экспорт из Active Directory
- `ad_users_export.txt` - текстовый экспорт из Active Directory
- `log.txt` - лог обработки
- `ad_export.log` - лог экспорта из AD

#### Структура основного Excel файла:

1. **Основной лист** - объединенные данные из всех систем
2. **Сравнение AD и Штатки** - расхождения между AD и штатным расписанием
3. **Дубли в [системе]** - внутренние дубликаты в каждой системе
4. **Удалить из [системы]** - пользователи для удаления (активные в системе, но отсутствующие в AD)

## Особенности обработки данных

### Автоматическое определение файлов

- Программа ищет самый новый Excel файл в каждой папке
- Поддерживаются форматы `.xlsx` и `.xls`
- Файлы могут иметь любые имена
- Проверяется актуальность файлов (не старше 180 дней)

### Нормализация ФИО

- Замена буквы "ё" на "е"
- Приведение к верхнему регистру
- Извлечение имени и фамилии (без отчества)

### Обработка формата 1С

Программа поддерживает новый формат отчета 1С:
- Данные начинаются со строки "Пользователь"
- ФИО находятся в столбце A
- Статус активности в столбце E ("Недействителен")
- "Нет" = пользователь активен, "Да" = пользователь неактивен

### Цветовое выделение

- Красный цвет - дубликаты
- Желтый цвет - предупреждения

## Настройка Active Directory

Для работы экспорта из AD необходимо настроить PowerShell команду в `ad_export.py`. Программа использует два метода экспорта:

1. **Через DirectorySearcher** - основной метод
2. **Через Get-ADUser** - резервный метод (требует модуль ActiveDirectory)

## Логирование

Программа ведет детальное логирование в файлы:

- `log.txt` - общий процесс обработки
- `ad_export.log` - процесс экспорта из Active Directory

Уровень логирования настраивается в `config.py`:
```python
LOG_LEVEL = logging.INFO  # DEBUG, INFO, WARNING, ERROR, CRITICAL
```

## Обработка ошибок

- Программа продолжает работу при отсутствии некоторых файлов
- Подробные сообщения об ошибках записываются в логи
- Создаются пустые файлы при невозможности получения данных
- Автоматическое переключение на альтернативные методы при ошибках

## Технические требования

### Поддерживаемые форматы файлов
- Excel (.xlsx, .xls)
- Текстовые файлы (.txt)

### Используемые библиотеки
- pandas - обработка данных
- openpyxl - работа с Excel файлами
- tqdm - индикаторы прогресса

## Поддержка

При возникновении проблем:

1. Проверьте логи в папке `вывод/log/`
2. Убедитесь в актуальности исходных файлов
3. Проверьте корректность формата входных данных
4. Убедитесь в наличии прав доступа к Active Directory
5. Проверьте, что файлы не старше 180 дней

### Частые проблемы и решения

**Проблема:** "Актуальный файл [системы] не найден"

**Решение:** Убедитесь, что файл находится в правильной папке и его дата изменения не старше 180 дней


**Проблема:** Ошибки при экспорте из AD

**Решение:** Проверьте права доступа к Active Directory и настройки домена


**Проблема:** Данные из систем не загружаются

**Решение:** Проверьте формат Excel файлов и наличие нужных столбцов

## Обновления

### Версия 2.0
- Автоматический поиск файлов по папкам
- Поддержка нового формата 1С
- Переименование систем (Диадок → Сфера Курьер, Контур → Контур Диадок)
- Улучшенная обработка ошибок
- Расширенное логирование

### Версия 1.0
- Базовая функциональность сравнения
- Ручное указание имен файлов
- Поддержка старого формата 1С
